extends layout

block content
  script(src="https://cdn.jsdelivr.net/npm/chart.js")
  .container
    p
      a.back-link(href='/') â† Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ð½Ð° Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ
    h1= title

    p.page-subtitle ÐÐ½Ð°Ð»Ð¸Ð· Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ Ð´Ð¾Ð¼ÐµÐ½Ð°Ð¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÐµÐ¹

    .summary-cards
      .summary-card
        .summary-number= totalDomains
        .summary-label Ð”Ð¾Ð¼ÐµÐ½Ð¾Ð²
      .summary-card.success
        .summary-number= totalDelivered
        .summary-label Ð”Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¾
      .summary-card.failed
        .summary-number= totalFailed
        .summary-label ÐÐµ Ð´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¾

    .view-toggle
      button.toggle-btn.active(onclick="switchView('table')") ðŸ“Š Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð°
      button.toggle-btn(onclick="switchView('chart')") ðŸ“ˆ Ð“Ñ€Ð°Ñ„Ð¸Ðº

    #table-view.view-content.active
      table.stats-table
        thead
          tr
            th Ð”Ð¾Ð¼ÐµÐ½
            th.center Ð”Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¾
            th.center ÐÐµ Ð´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¾
            th.center Ð’ÑÐµÐ³Ð¾
            th Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ°
        tbody#stats-tbody
          each domain in domains
            - const successRate = ((domain.delivered / domain.total) * 100).toFixed(1).replace('.0', '')
            - const progressClass = successRate > 80 ? 'good' : successRate > 50 ? 'medium' : 'bad'
             tr
              td.domain-cell= domain.domain
              td.success-cell= domain.delivered
              td.failed-cell= domain.failed
              td.total-cell= domain.total
              td.progress-cell
                .progress-container
                  .progress-bar
                    .progress-fill(class=progressClass style=`width: ${successRate}%`)
                  span.progress-text= `${successRate}%`

    #chart-view.view-content
      .chart-controls
        button.chart-btn.active(onclick="showChart('bar')") Ð¡Ñ‚Ð¾Ð»Ð±Ñ†Ñ‹
        button.chart-btn(onclick="showChart('pie')") ÐšÑ€ÑƒÐ³Ð¾Ð²Ð°Ñ
      .chart-container
        canvas#statsChart

    script.
      const domainsData = !{JSON.stringify(domains)};
      let currentChart = null;
      const ctx = document.getElementById('statsChart').getContext('2d');

      function createChart(type) {
        if (currentChart) {
          currentChart.destroy();
        }

        // top-10 domains for chart
        const topDomains = domainsData
          .sort((a, b) => (b.delivered + b.failed) - (a.delivered + a.failed))
          .slice(0, 10);

        const config = {
          type,
          data: {
            labels: topDomains.map(d => d.domain),
            datasets: [
              {
                label: 'Ð”Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¾',
                data: topDomains.map(d => d.delivered),
                backgroundColor: 'rgba(72, 187, 120, 0.8)',
                borderColor: 'rgb(56, 161, 105)',
                borderWidth: 2
              },
              {
                label: 'ÐÐµ Ð´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¾',
                data: topDomains.map(d => d.failed),
                backgroundColor: 'rgba(229, 62, 62, 0.8)',
                borderColor: 'rgb(197, 48, 48)',
                borderWidth: 2
              }
            ]
          },
          options: {
            indexAxis: 'x',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  font: { size: 14 },
                  padding: 15
                }
              },
              title: {
                display: true,
                text: 'Ð¢Ð¾Ð¿-10 Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð² Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹',
                font: { size: 16, weight: 'bold' },
                padding: 20
              }
            },
            scales: type !== 'pie' ? {
              x: {
                stacked: false,
                grid: { display: false }
              },
              y: {
                stacked: false,
                beginAtZero: true
              }
            } : {}
          }
        };

        if (type === 'pie') {
          config.data = {
            labels: topDomains.map(d => d.domain),
            datasets: [{
              label: 'Ð’ÑÐµÐ³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹',
              data: topDomains.map(d => d.delivered + d.failed),
              backgroundColor: [
                '#667eea', '#764ba2', '#f093fb', '#f5576c',
                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                '#fa709a', '#fee140', '#30cfd0', '#330867',
                '#a8edea', '#fed6e3', '#ffecd2'
              ]
            }]
          };
        }

        currentChart = new Chart(ctx, config);
      }

      function switchView(view) {
        document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));

        if (view === 'table') {
          document.getElementById('table-view').classList.add('active');
          document.querySelectorAll('.toggle-btn')[0].classList.add('active');
        } else {
          document.getElementById('chart-view').classList.add('active');
          document.querySelectorAll('.toggle-btn')[1].classList.add('active');
          if (!currentChart) createChart('bar');
        }
      }

      function showChart(type) {
        document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        createChart(type);
      }

      createChart('bar');